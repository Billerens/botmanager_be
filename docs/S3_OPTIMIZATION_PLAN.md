# План оптимизации S3 админ-панели

## Проблемы текущей реализации

1. **Загрузка всех файлов** - загружаем до 10000 файлов, потом пагинация
2. **N+1 запросов к БД** - для каждого файла делаем запрос для определения entity
3. **Медленная статистика** - пересчитывается каждый раз
4. **Нет кэширования** - каждый запрос идет в S3

## Варианты оптимизации

### ✅ Вариант 1: Файловая система (РЕКОМЕНДУЕТСЯ)

**Преимущества:**
- Загружаем только текущий уровень
- Быстрая навигация
- Меньше данных передается
- Лучший UX

**Реализация:**
1. На верхнем уровне показываем только папки
2. При клике на папку загружаем её содержимое
3. Entity загружаем лениво (только для видимых файлов)
4. Кэшируем структуру папок

**API изменения:**
```
GET /admin/s3/folders?prefix= - список папок на уровне
GET /admin/s3/files?prefix=products/&page=1 - файлы в папке с пагинацией
GET /admin/s3/files/:key/entity - entity для конкретного файла (лениво)
```

### Вариант 2: Пагинация на стороне S3

**Преимущества:**
- Используем встроенную пагинацию S3
- Не загружаем лишние данные

**Недостатки:**
- Сложнее реализовать поиск
- Нет общего количества (S3 не возвращает total)

**Реализация:**
- Использовать continuationToken для пагинации
- Entity загружать лениво батчами

### Вариант 3: Гибридный

**Преимущества:**
- Файловая система для навигации
- Пагинация внутри папок
- Кэширование

## Рекомендуемый подход: Файловая система + Ленивая загрузка

### Backend изменения:

1. **Новый метод `getFolders(prefix?)`** - возвращает только папки на уровне
2. **Модифицированный `getFiles(prefix, page, limit)`** - только файлы в папке с пагинацией
3. **Ленивая загрузка entity** - отдельный эндпоинт или опциональный параметр
4. **Кэширование структуры папок** - Redis или in-memory кэш

### Frontend изменения:

1. **Древовидная навигация** - Tree компонент для папок
2. **Таблица файлов** - только для текущей папки
3. **Ленивая загрузка entity** - при наведении или клике
4. **Breadcrumbs** - для навигации по папкам

## Дополнительные оптимизации

1. **Кэширование статистики** - Redis, TTL 5 минут
2. **Батчинг запросов entity** - загружать entity для нескольких файлов одним запросом
3. **Виртуализация таблицы** - показывать только видимые строки
4. **Debounce поиска** - не искать при каждом символе
5. **Индексация в БД** - создать таблицу file_entities для быстрого поиска

## План реализации

### Этап 1: Backend - Файловая система API
- [ ] Добавить метод `getFolders(prefix?)` в S3Service
- [ ] Модифицировать `getFiles` для работы только с текущей папкой
- [ ] Сделать entity опциональным (ленивая загрузка)
- [ ] Добавить кэширование структуры папок

### Этап 2: Backend - Оптимизация entity
- [ ] Батчинг запросов entity
- [ ] Кэширование entity связей
- [ ] Индексация в БД (опционально)

### Этап 3: Frontend - Файловая система UI
- [ ] Tree компонент для папок
- [ ] Breadcrumbs навигация
- [ ] Ленивая загрузка entity
- [ ] Виртуализация таблицы

### Этап 4: Оптимизация статистики
- [ ] Кэширование статистики
- [ ] Фоновое обновление
- [ ] Инкрементальное обновление
