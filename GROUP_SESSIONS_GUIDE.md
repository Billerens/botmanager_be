# üìö –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≥—Ä—É–ø–ø–æ–≤—ã–º —Å–µ—Å—Å–∏—è–º

## üéØ –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞ –≤ –æ–¥–Ω—É —Å–µ—Å—Å–∏—é –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è: —á–∞—Ç—ã, –∏–≥—Ä—ã, –∞—É–∫—Ü–∏–æ–Ω—ã, –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.

## ‚ú® –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–î–æ 10,000 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤** –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ
- **–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø** –≤ –æ–¥–Ω–æ–º –±–æ—Ç–µ (–¥–æ 1000 –∞–∫—Ç–∏–≤–Ω—ã—Ö)
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** —á–µ—Ä–µ–∑ Bull Queue –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
- **–ê–≤—Ç–æ–∞—Ä—Ö–∏–≤–∞—Ü–∏—è** –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
- **4 —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–º–∏—Ç–∏–≤–∞** –¥–ª—è –ª—é–±—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **GroupSession** (Entity) - –≥—Ä—É–ø–ø–æ–≤–∞—è —Å–µ—Å—Å–∏—è
2. **GroupSessionService** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏
3. **4 –Ω–æ–≤—ã—Ö —Ç–∏–ø–∞ –Ω–æ–¥** - –ø—Ä–∏–º–∏—Ç–∏–≤—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä—É–ø–ø–∞–º–∏
4. **GroupActionsProcessor** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –ù–æ–≤—ã–µ —Ç–∏–ø—ã –Ω–æ–¥

- `GROUP_CREATE` - —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
- `GROUP_JOIN` - –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –≥—Ä—É–ø–ø–µ
- `GROUP_ACTION` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (broadcast, collect, aggregate, condition)
- `GROUP_LEAVE` - –≤—ã—Ö–æ–¥ –∏–∑ –≥—Ä—É–ø–ø—ã

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–∞—è –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞

```
[START]
  ‚Üì
[GROUP_CREATE]
  - variableName: "quiz_group"
  - maxParticipants: 10
  ‚Üì
[MESSAGE: "–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞! –ö–æ–¥ –≥—Ä—É–ø–ø—ã: {quiz_group}"]
  ‚Üì
[GROUP_ACTION: condition]
  - field: "participantCount"
  - operator: "greaterThan"
  - value: 1
  ‚Üì
[GROUP_ACTION: broadcast]
  - message: "–ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è! –í–æ–ø—Ä–æ—Å: –°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2+2?"
  ‚Üì
[NEW_MESSAGE: –ª—é–±–æ–π –æ—Ç–≤–µ—Ç]
  ‚Üì
[VARIABLE: user_answer = {message.text}]
  ‚Üì
[GROUP_ACTION: collect]
  - variableName: "user_answer"
  - aggregateAs: "all_answers"
  - timeout: 30
  - waitForAll: false
  ‚Üì
[GROUP_ACTION: broadcast]
  - message: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {all_answers}"
  ‚Üì
[GROUP_LEAVE]
```

### –ü—Ä–∏–º–µ—Ä 2: –ê—É–∫—Ü–∏–æ–Ω

```
[START]
  ‚Üì
[GROUP_CREATE]
  - variableName: "auction_id"
  ‚Üì
[VARIABLE: current_bid = 100]
  ‚Üì
[GROUP_ACTION: broadcast]
  - message: "–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞: {current_bid}‚ÇΩ. –î–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫–∏!"
  ‚Üì
[NEW_MESSAGE: —á–∏—Å–ª–æ]
  ‚Üì
[VARIABLE: user_bid = {message.text}]
  ‚Üì
[GROUP_ACTION: collect]
  - variableName: "user_bid"
  - aggregateAs: "all_bids"
  - timeout: 30
  ‚Üì
[GROUP_ACTION: aggregate]
  - operation: "max"
  - sourceVariable: "all_bids"
  - targetVariable: "winning_bid"
  - scope: "group"
  ‚Üì
[GROUP_ACTION: broadcast]
  - message: "–ü–æ–±–µ–¥–Ω–∞—è —Å—Ç–∞–≤–∫–∞: {winning_bid}‚ÇΩ!"
  ‚Üì
[END]
```

### –ü—Ä–∏–º–µ—Ä 3: –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç

```
[START]
  ‚Üì
[GROUP_CREATE]
  - variableName: "chat_id"
  ‚Üì
[MESSAGE: "–ß–∞—Ç —Å–æ–∑–¥–∞–Ω. –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π –∫–æ–¥–æ–º: {chat_id}"]
  ‚Üì
[NEW_MESSAGE: –ª—é–±–æ–µ]
  ‚Üì
[CONDITION: message.text === "/leave"?]
  ‚îú‚îÄ True ‚Üí [GROUP_LEAVE]
  ‚îî‚îÄ False ‚Üí [GROUP_ACTION: broadcast]
                - message: "{user.first_name}: {message.text}"
                - excludeSelf: false
                ‚Üì
              [–¶–∏–∫–ª –æ–±—Ä–∞—Ç–Ω–æ –∫ NEW_MESSAGE]
```

## üîß API

### GroupSessionService

```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
const group = await groupSessionService.create(
  botId: string,
  flowId: string,
  creatorUserId: string,
  metadata?: { maxSize?: number, ... }
);

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
await groupSessionService.addParticipant(groupId, userId);

// –£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
await groupSessionService.removeParticipant(groupId, userId);

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
await groupSessionService.updateSharedVariables(groupId, {
  score: 100,
  round: 2
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
const sessions = await groupSessionService.getParticipantSessions(groupId);

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
const stats = await groupSessionService.getBotGroupStats(botId);
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–æ–¥

#### GROUP_CREATE

```json
{
  "type": "group_create",
  "data": {
    "groupCreate": {
      "variableName": "my_group",
      "maxParticipants": 100,
      "metadata": {
        "gameType": "quiz",
        "difficulty": "hard"
      }
    }
  }
}
```

#### GROUP_JOIN

```json
{
  "type": "group_join",
  "data": {
    "groupJoin": {
      "groupIdSource": "{group_code}",
      "role": "participant",
      "onFullAction": "create_new"
    }
  }
}
```

#### GROUP_ACTION (Broadcast)

```json
{
  "type": "group_action",
  "data": {
    "groupAction": {
      "actionType": "broadcast",
      "broadcast": {
        "message": "–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º! –°—á–µ—Ç: {score}",
        "excludeSelf": false,
        "buttons": [
          { "text": "–û—Ç–≤–µ—Ç–∏—Ç—å", "callbackData": "answer" }
        ]
      }
    }
  }
}
```

#### GROUP_ACTION (Collect)

```json
{
  "type": "group_action",
  "data": {
    "groupAction": {
      "actionType": "collect",
      "collect": {
        "variableName": "vote",
        "aggregateAs": "all_votes",
        "timeout": 60,
        "waitForAll": false
      }
    }
  }
}
```

#### GROUP_ACTION (Aggregate)

```json
{
  "type": "group_action",
  "data": {
    "groupAction": {
      "actionType": "aggregate",
      "aggregate": {
        "operation": "sum",
        "sourceVariable": "points",
        "targetVariable": "total_points",
        "scope": "group"
      }
    }
  }
}
```

#### GROUP_ACTION (Condition)

```json
{
  "type": "group_action",
  "data": {
    "groupAction": {
      "actionType": "condition",
      "condition": {
        "field": "participantCount",
        "operator": "greaterThan",
        "value": 5
      }
    }
  }
}
```

#### GROUP_LEAVE

```json
{
  "type": "group_leave",
  "data": {
    "groupLeave": {
      "notifyOthers": true,
      "notificationMessage": "–£—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª –∏–∑ –≥—Ä—É–ø–ø—ã",
      "cleanupIfEmpty": true
    }
  }
}
```

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- **Redis Set** –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (O(1) –æ–ø–µ—Ä–∞—Ü–∏–∏)
- **Bull Queue** –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
- **–ü–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–æ 100 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–∏ broadcast
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –≥—Ä—É–ø–ø –≤ Redis (TTL 1 —á–∞—Å)

### –ú–µ—Ç—Ä–∏–∫–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è |
|----------|-------|
| –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã | ~5ms |
| –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ | ~2ms |
| Broadcast 100 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ | ~100ms |
| Broadcast 10,000 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ | ~2-5s |
| Collect –æ—Ç 1000 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ | ~5-10s |

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –õ–∏–º–∏—Ç—ã (backend/src/modules/bots/group-session.service.ts)

```typescript
export const GROUP_LIMITS = {
  MAX_PARTICIPANTS_PER_GROUP: 10000,
  MAX_ACTIVE_GROUPS_PER_BOT: 1000,
  MAX_GROUPS_PER_USER_PER_BOT: 1,
  AUTO_ARCHIVE_DAYS: 7,
};
```

### –ê–≤—Ç–æ–∞—Ä—Ö–∏–≤–∞—Ü–∏—è

–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 —É—Ç—Ä–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ cron):

```typescript
@Cron(CronExpression.EVERY_DAY_AT_3AM)
async archiveInactiveGroups(): Promise<void> {
  // –ê—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç –≥—Ä—É–ø–ø—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –±–æ–ª–µ–µ 7 –¥–Ω–µ–π
}
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä—É–ø–ø

```typescript
const stats = await groupSessionService.getBotGroupStats(botId);

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
{
  totalGroups: 150,
  activeGroups: 45,
  completedGroups: 80,
  archivedGroups: 25,
  totalParticipants: 3500,
  averageGroupSize: 23.3,
  largestGroup: 250
}
```

### –õ–æ–≥–∏

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `CustomLoggerService`:

```
[GroupSessionService] –°–æ–∑–¥–∞–Ω–∞ –≥—Ä—É–ø–ø–∞ abc-123 –¥–ª—è –±–æ—Ç–∞ bot-456
[GroupActionNodeHandler] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ broadcast –¥–ª—è –≥—Ä—É–ø–ø—ã abc-123
[GroupActionsProcessor] Broadcast –∑–∞–≤–µ—Ä—à–µ–Ω. –£—Å–ø–µ—à–Ω–æ: 98, –û—à–∏–±–æ–∫: 2
```

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è

–î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
npm run typeorm migration:run
```

–ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `group_sessions` —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏:
- `IDX_GROUP_SESSIONS_BOT_STATUS`
- `IDX_GROUP_SESSIONS_FLOW`
- `IDX_GROUP_SESSIONS_STATUS_UPDATED`

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø—ã –≤ Redis

```bash
redis-cli
> GET "group:abc-123"
> SMEMBERS "group:abc-123:participants"
> HGETALL "group:abc-123:action:node-456:responses"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–∏ Bull

```bash
redis-cli
> LLEN "bull:group-actions:waiting"
> LLEN "bull:group-actions:active"
> LLEN "bull:group-actions:completed"
```

## üìå –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–Ω–∞ –≥—Ä—É–ø–ø–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø–µ –±–æ—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. **Collect —Å –æ–ø–æ–∑–¥–∞–≤—à–∏–º–∏**: –ü—Ä–∏ timeout —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –æ–ø–æ–∑–¥–∞–≤—à–∏—Ö –≤ `{aggregateAs}_late_users`
3. **Broadcast –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π**: –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è flow
4. **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞**: –ü—É—Å—Ç—ã–µ –≥—Ä—É–ø–ø—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞—Ä—Ö–∏–≤–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Backend
- `backend/src/database/entities/group-session.entity.ts`
- `backend/src/modules/bots/group-session.service.ts`
- `backend/src/modules/bots/nodes/group-*-node.handler.ts`
- `backend/src/modules/bots/processors/group-actions.processor.ts`
- `backend/src/database/migrations/1700000000025-AddGroupSessionsTable.ts`

### Frontend
- `frontend/src/types/flow.ts` (–æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∏–ø—ã)

## üéì –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Bull Queue –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://github.com/OptimalBits/bull)
- [TypeORM Relations](https://typeorm.io/relations)
- [NestJS CRON](https://docs.nestjs.com/techniques/task-scheduling)

