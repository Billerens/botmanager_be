# Миграция системы кастомных доменов

## Обзор изменений

Система кастомных доменов была переработана для упрощения настройки и улучшения пользовательского опыта.

### Что изменилось

**До:**

- Использовался CNAME proxy (`proxy.botmanagertest.online`)
- Пользователь создавал CNAME запись, указывающую на proxy
- Требовалась сложная верификация владения доменом
- Caddy использовался для on-demand TLS

**После:**

- Используется прямая A-запись на IP фронтенд-сервера
- Пользователь создает A-запись, указывающую на IP сервера
- Упрощенная верификация (опционально)
- Фронтенд определяет ресурс через API запрос к бэкенду

## Архитектура

### Выбор типа домена

Пользователь может выбрать один из двух вариантов:

1. **Субдомен платформы** (бесплатно):

   - `{slug}.shops.botmanagertest.online`
   - `{slug}.booking.botmanagertest.online`
   - `{slug}.pages.botmanagertest.online`
   - Автоматическая настройка DNS и SSL

2. **Кастомный домен**:
   - `shop.example.com`
   - `booking.mysite.com`
   - Требует настройки A-записи пользователем
   - Автоматический SSL через Let's Encrypt

### Процесс работы с кастомным доменом

1. **Добавление домена:**

   - Пользователь указывает домен (например, `shop.example.com`)
   - Система создает запись в БД со статусом `awaiting_dns`

2. **Настройка DNS:**

   - Пользователь получает инструкции:
     - Тип: A
     - Имя: @ (или поддомен)
     - Значение: IP фронтенд-сервера
     - TTL: 3600
   - Пользователь настраивает DNS в своем регистраторе

3. **Проверка DNS:**

   - Пользователь нажимает "Проверить DNS"
   - Система проверяет A-запись
   - Если корректно → статус `active`

4. **Доступ к ресурсу:**
   - Пользователь открывает `shop.example.com`
   - Фронтенд определяет, что это кастомный домен
   - Фронтенд делает запрос: `GET /api/public/domain-resolver/resolve?domain=shop.example.com`
   - Бэкенд возвращает: `{ type: "shop", id: "uuid", slug: "my-shop" }`
   - Фронтенд отображает соответствующий магазин/букинг/страницу

## Изменения в коде

### Backend

#### Новые файлы:

1. **`modules/domain-resolver/`** - новый модуль для резолва доменов:

   - `domain-resolver.controller.ts` - публичный endpoint `/api/public/domain-resolver/resolve`
   - `domain-resolver.service.ts` - логика резолва домена в ресурс
   - `domain-resolver.module.ts` - модуль

2. **`database/migrations/1700000000050-UpdateCustomDomainsToARecord.ts`** - миграция БД

#### Измененные файлы:

1. **`database/entities/custom-domain.entity.ts`:**

   - Заменено поле `expectedCname` на `expectedIp`

2. **`modules/custom-domains/services/custom-domains.service.ts`:**

   - Обновлена логика создания домена (используется IP вместо CNAME)
   - Обновлены инструкции для пользователя (A-запись вместо CNAME)

3. **`modules/custom-domains/services/dns-validator.service.ts`:**

   - Приоритет отдан проверке A-записи
   - Убрана проверка CNAME

4. **`modules/custom-domains/dto/custom-domain.dto.ts`:**

   - Обновлены типы (A вместо CNAME)

5. **`app.module.ts`:**
   - Добавлен `DomainResolverModule`

### Frontend

#### Новые файлы:

1. **`services/domainResolverService.ts`** - сервис для резолва кастомных доменов

2. **`components/CustomDomainField/`** - компонент для управления кастомными доменами:
   - `CustomDomainField.tsx` - основной компонент
   - `CustomDomainField.module.scss` - стили
   - `index.ts` - экспорты

#### Измененные файлы:

1. **`utils/subdomain.ts`:**

   - Добавлена поддержка кастомных доменов
   - Добавлено поле `isCustomDomain` в `SubdomainInfo`
   - Добавлена функция `isCustomDomain()` для определения кастомного домена

2. **`pages/PublicSubdomain/PublicSubdomainRouter.tsx`:**

   - Добавлена поддержка кастомных доменов
   - Функция `resolveResource()` теперь работает как с субдоменами, так и с кастомными доменами

3. **`App.tsx`:**
   - Добавлена проверка на кастомный домен
   - Передача `customDomain` в `PublicSubdomainRouter`

## Настройка окружения

### Backend

Добавьте в `.env`:

```env
# IP-адрес фронтенд-сервера для A-записей кастомных доменов
FRONTEND_IP=your.frontend.ip.address
```

### Frontend

Переменные окружения остаются без изменений.

## Миграция данных

1. Запустите миграцию БД:

```bash
cd backend
npm run migration:run
```

2. Обновите существующие домены:
   - Старые домены с CNAME останутся в статусе `awaiting_dns`
   - Пользователям нужно будет пересоздать домены с A-записью
   - Или можно написать скрипт для автоматического обновления

## Инструкции для пользователей

### Настройка кастомного домена

1. **Выберите тип домена:**

   - Субдомен платформы (бесплатно, автоматическая настройка)
   - Кастомный домен (требует настройки DNS)

2. **Для кастомного домена:**

   **Шаг 1: Добавьте домен**

   - Нажмите "Добавить домен"
   - Введите полное доменное имя (например, `shop.example.com`)
   - Нажмите "Добавить"

   **Шаг 2: Настройте DNS**

   - Войдите в панель управления DNS вашего домена (у регистратора)
   - Добавьте A-запись:
     - Тип: `A`
     - Имя: `@` (для корневого домена) или имя поддомена (например, `shop`)
     - Значение: IP-адрес из инструкции
     - TTL: `3600` (или оставьте по умолчанию)
   - Сохраните изменения

   **Шаг 3: Проверьте DNS**

   - Подождите 5-30 минут (DNS изменения распространяются)
   - Нажмите "Проверить DNS" в панели управления
   - Если проверка успешна - домен активируется

   **Шаг 4: Готово!**

   - Ваш ресурс доступен по кастомному домену
   - SSL-сертификат выдается автоматически

### Советы

- Если используете Cloudflare, можно оставить проксирование включенным
- DNS изменения обычно применяются за 5-30 минут, но могут занять до 48 часов
- После настройки DNS нажмите кнопку "Проверить DNS" для активации
- Можно использовать как корневой домен (`example.com`), так и поддомен (`shop.example.com`)

## Преимущества новой системы

1. **Упрощенная настройка:**

   - Одна A-запись вместо CNAME + верификация
   - Понятные инструкции для пользователя

2. **Гибкость:**

   - Выбор между субдоменом платформы и кастомным доменом
   - Поддержка Cloudflare и других CDN

3. **Производительность:**

   - Прямой доступ к фронтенду без proxy
   - Меньше DNS-запросов

4. **Масштабируемость:**
   - Легко добавить несколько фронтенд-серверов
   - Возможность использования балансировщика нагрузки

## Обратная совместимость

- Субдомены платформы (`*.shops.*`, `*.booking.*`, `*.pages.*`) работают как раньше
- Старые кастомные домены с CNAME нужно пересоздать с A-записью
- API остается обратно совместимым

## Troubleshooting

### Домен не активируется

1. Проверьте A-запись через DNS lookup:

   ```bash
   nslookup shop.example.com
   ```

   Должен вернуться IP фронтенд-сервера

2. Подождите больше времени (до 48 часов)

3. Проверьте, нет ли конфликтующих записей (CNAME, другие A-записи)

### SSL не работает

- SSL-сертификаты выдаются автоматически через Let's Encrypt
- Убедитесь, что домен правильно указывает на сервер
- Подождите несколько минут после активации DNS

### Ошибка "Domain not allowed"

- Убедитесь, что домен добавлен в панели управления
- Проверьте статус домена (должен быть `active`)
- Проверьте, что DNS настроен правильно
